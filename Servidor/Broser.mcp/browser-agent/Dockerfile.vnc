# Browser Agent with Playwright MCP + noVNC
# Streaming ao vivo do browser

FROM mcr.microsoft.com/playwright:v1.56.1-jammy

# Set working directory
WORKDIR /app

# Set noninteractive mode to prevent tzdata prompt
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install VNC and noVNC dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    dumb-init \
    xvfb \
    x11vnc \
    fluxbox \
    novnc \
    websockify \
    supervisor \
    curl \
    && rm -rf /var/lib/apt/lists/*
# Install Google Chrome (real browser, no automation banner)
RUN curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg \
    && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list \
    && apt-get update \
    && apt-get install -y google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# Hide noVNC toolbar with CSS only (don't remove HTML elements to avoid JS errors)
RUN sed -i 's|</head>|<style>#noVNC_status_bar{display:none!important;height:0!important;visibility:hidden!important;position:absolute!important;top:-9999px!important}html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000}#noVNC_screen{width:100%!important;height:100%!important}canvas{display:block}</style></head>|' /usr/share/novnc/vnc_lite.html && \
    echo '#noVNC_status_bar { display: none !important; height: 0 !important; visibility: hidden !important; } html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; } #noVNC_screen { width: 100% !important; height: 100% !important; } canvas { display: block; }' >> /usr/share/novnc/app/styles/lite.css

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy source code
COPY dist/ ./dist/

# Copy stealth script for anti-detection
COPY stealth.js ./stealth.js

# Create directories
RUN mkdir -p /data/profiles /data/screenshots /var/log/supervisor

# Copy supervisor config
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Copy startup script
COPY start-vnc.sh /start-vnc.sh
RUN chmod +x /start-vnc.sh

# Environment variables
ENV NODE_ENV=production
ENV MCP_PORT=3000
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
ENV DISPLAY=:99
ENV VNC_PORT=5900
ENV NOVNC_PORT=6080
ENV SCREEN_WIDTH=1920
ENV SCREEN_HEIGHT=1080
ENV SCREEN_DEPTH=24

# Expose ports
EXPOSE 3000 5900 6080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Use dumb-init for proper signal handling
ENTRYPOINT ["dumb-init", "--"]

# Start all services via supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
