# Browser Agent with Playwright MCP + noVNC
# Streaming ao vivo do browser

FROM mcr.microsoft.com/playwright:v1.56.1-jammy

# Set working directory
WORKDIR /app

# Set noninteractive mode to prevent tzdata prompt
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install VNC and noVNC dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    dumb-init \
    xvfb \
    x11vnc \
    fluxbox \
    novnc \
    websockify \
    supervisor \
    curl \
    && rm -rf /var/lib/apt/lists/*
# Install Google Chrome (real browser, no automation banner)
RUN curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg \
    && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list \
    && apt-get update \
    && apt-get install -y google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# Hide noVNC toolbar/control bar with CSS in BOTH vnc.html and vnc_lite.html
# The full vnc.html has: #noVNC_control_bar, #noVNC_control_bar_anchor
# The lite vnc_lite.html has: #noVNC_status_bar
RUN HIDE_CSS='<style>*{box-sizing:border-box}#noVNC_control_bar,#noVNC_control_bar_anchor,#noVNC_status_bar,.noVNC_status_error,.noVNC_status_warn,.noVNC_status_normal{display:none!important;height:0!important;width:0!important;visibility:hidden!important;position:absolute!important;top:-9999px!important;left:-9999px!important;pointer-events:none!important;opacity:0!important}html,body{margin:0!important;padding:0!important;width:100%!important;height:100%!important;overflow:hidden!important;background:#000!important}#noVNC_container,#noVNC_screen{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;margin:0!important;padding:0!important}#noVNC_canvas{width:100%!important;height:100%!important}</style>' && \
    sed -i "s|</head>|${HIDE_CSS}</head>|" /usr/share/novnc/vnc.html && \
    sed -i "s|</head>|${HIDE_CSS}</head>|" /usr/share/novnc/vnc_lite.html && \
    echo '#noVNC_control_bar, #noVNC_control_bar_anchor, #noVNC_status_bar { display: none !important; }' >> /usr/share/novnc/app/styles/base.css 2>/dev/null || true

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Install Patchright browser (undetected Chromium)
# This removes Runtime.enable leak that causes "50% like-headless" detection
RUN npx patchright install chromium

# Copy source code
COPY dist/ ./dist/

# Copy stealth script for anti-detection
COPY stealth.js ./stealth.js

# Create directories
RUN mkdir -p /data/profiles /data/screenshots /var/log/supervisor

# Copy supervisor config
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Copy startup script
COPY start-vnc.sh /start-vnc.sh
RUN chmod +x /start-vnc.sh

# Environment variables
ENV NODE_ENV=production
ENV MCP_PORT=3000
# Patchright installs browsers to its own path (not playwright's)
# Let patchright find its own browser automatically
ENV DISPLAY=:99
ENV VNC_PORT=5900
ENV NOVNC_PORT=6080
ENV SCREEN_WIDTH=1920
ENV SCREEN_HEIGHT=1080
ENV SCREEN_DEPTH=24

# Expose ports
EXPOSE 3000 5900 6080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Use dumb-init for proper signal handling
ENTRYPOINT ["dumb-init", "--"]

# Start all services via supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
