version: '3.8'
name: brosermcp

# ===========================================
# Browser MCP - Full Orchestration Stack
# ===========================================
#
# Uso:
#   docker-compose build      # Constr√≥i as imagens
#   docker-compose up -d      # Sobe tudo
#   docker-compose down       # Para tudo
#   docker-compose logs -f    # Ver logs
#

services:
  # ===========================================
  # ORCHESTRATOR
  # Gerencia containers de browser dinamicamente
  # ===========================================
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: browser-orchestrator
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080
      - API_SECRET_KEY=${API_SECRET_KEY}
      - BROWSER_AGENT_IMAGE=liftlio/browser-agent:latest
      - MCP_BASE_PORT=10100
      - MAX_CONTAINERS=${MAX_CONTAINERS:-6}
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-30}
      - CLEANUP_INTERVAL_MINUTES=5
      - HOST_IP=${HOST_IP:-localhost}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
#      - DATAIMPULSE_LOGIN=${DATAIMPULSE_LOGIN}
#      - DATAIMPULSE_PASSWORD=${DATAIMPULSE_PASSWORD}
#      - DATAIMPULSE_HOST=${DATAIMPULSE_HOST:-gw.dataimpulse.com}
#      - DATAIMPULSE_STICKY_BASE_PORT=${DATAIMPULSE_STICKY_BASE_PORT:-10000}
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - browser-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # BROWSER AGENT 117 (Liftlio principal)
  # Container com VNC + auto-timeout + google.com
  # ===========================================
  browser-agent-117:
    build:
      context: ./browser-agent
      dockerfile: Dockerfile.vnc
    image: liftlio/browser-agent:latest
    container_name: browser-agent-117
    restart: unless-stopped
    labels:
      - "liftlio.project=117"
      - "liftlio.user=anonymous"
      - "liftlio.type=browser-agent"
    ports:
      - "10100:3000"    # MCP API
      - "16080:6080"    # noVNC (VNC streaming)
    environment:
      - NODE_ENV=production
      - PROJECT_ID=117
      - PROJECT_INDEX=0
      - MCP_PORT=3000
      - PROFILES_DIR=/data/profiles
      - HEADLESS=false
      - VNC_TIMEOUT_MINUTES=5
      - DEFAULT_URL=https://www.google.com
      # Proxy DataImpulse - DESABILITADO para testar assistantMode
      #- DATAIMPULSE_LOGIN=${DATAIMPULSE_LOGIN}
      #- DATAIMPULSE_PASSWORD=${DATAIMPULSE_PASSWORD}
      #- DATAIMPULSE_HOST=${DATAIMPULSE_HOST:-gw.dataimpulse.com}
      #- DATAIMPULSE_STICKY_BASE_PORT=${DATAIMPULSE_STICKY_BASE_PORT:-10000}
      # Claude API
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      # Rebrowser patches - Runtime.enable leak fix
      - REBROWSER_PATCHES_RUNTIME_FIX_MODE=alwaysIsolated
      - REBROWSER_PATCHES_DEBUG=1
      # CapMonster CAPTCHA Solver
      - CAPMONSTER_API_KEY=${CAPMONSTER_API_KEY}
    volumes:
      - browser-profiles:/data/profiles
      - browser-screenshots:/data/screenshots
    networks:
      - browser-network
    depends_on:
      - orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

volumes:
  browser-profiles:
    name: liftlio-browser-profiles
  browser-screenshots:
    name: liftlio-browser-screenshots

networks:
  browser-network:
    name: liftlio-browser-network
    driver: bridge
