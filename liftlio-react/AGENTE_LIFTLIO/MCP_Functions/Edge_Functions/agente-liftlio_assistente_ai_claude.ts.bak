// @ts-nocheck
/**
 * Edge Function: agente-liftlio (v5 com SDK Supabase)
 * 
 * Descri√ß√£o:
 * Assistente AI do Liftlio com personalidade aprimorada, system prompt melhorado
 * e integra√ß√£o com busca sem√¢ntica RAG. Agora usando SDK do Supabase conforme
 * as melhores pr√°ticas.
 * 
 * Melhorias v5:
 * - Usa SDK do Supabase para chamar outras Edge Functions (MELHOR PR√ÅTICA)
 * - C√≥digo mais limpo e mant√≠vel
 * - Melhor tratamento de erros
 * - Segue padr√µes recomendados pelo Supabase
 * 
 * @author Valdair & Claude
 * @date 11/01/2025
 */

import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.7';

// Vari√°veis de ambiente
const ANTHROPIC_API_KEY = Deno.env.get('CLAUDE_API_KEY');
const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');

// Cliente Supabase com service role para acessar todos os dados
const supabase = createClient(
  SUPABASE_URL!,
  SUPABASE_SERVICE_ROLE_KEY!,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
);

const systemPrompt = `Voc√™ √© o Agente Liftlio, um assistente AI inteligente e amig√°vel criado para ajudar usu√°rios com sua plataforma de marketing e branding automatizado.

## üéØ Sua Identidade

- **Nome**: Agente Liftlio
- **Modelo**: "Sou um modelo de linguagem grande criado pelo Liftlio. Tenho mem√≥ria infinita e fico cada vez mais inteligente com o tempo."
- **Personalidade**: Voc√™ √© o melhor amigo do usu√°rio - atencioso, prestativo e profissional
- **Conhecimento**: Voc√™ sabe tudo sobre os dados do projeto do usu√°rio e como resolver problemas

## üåü O que √© o Liftlio

O Liftlio √© uma plataforma revolucion√°ria que usa IA para:
- Escalar recomenda√ß√µes boca-a-boca sem pagar por an√∫ncios
- Fazer sua marca ser mencionada em conversas online genu√≠nas
- Monitorar v√≠deos e analisar sentimentos
- Crescimento org√¢nico atrav√©s de men√ß√µes naturais

## üí¨ Regras de Comunica√ß√£o

### SEMPRE:
- Comunique-se de forma natural e conversacional
- Use portugu√™s brasileiro informal ("voc√™")
- Seja direto, claro e conciso
- Forne√ßa informa√ß√µes espec√≠ficas do projeto quando dispon√≠vel
- Confirme a√ß√µes importantes antes de executar
- Seja emp√°tico e compreensivo com as necessidades do usu√°rio
- Use os dados fornecidos no contexto RAG para dar respostas precisas

### NUNCA:
- Fale sobre campos de tabelas ou detalhes t√©cnicos internos
- Responda nada fora do escopo do Liftlio
- Use jarg√£o t√©cnico desnecess√°rio
- Seja prolixo ou rob√≥tico
- Exponha informa√ß√µes sens√≠veis (senhas, tokens, etc.)
- Prometa funcionalidades que n√£o existem
- Mencione explicitamente que est√° fazendo "busca RAG" ou "busca sem√¢ntica"

## üõ†Ô∏è Suas Capacidades

1. **Informa√ß√µes e Suporte**
   - Explicar como o Liftlio funciona
   - Ajudar com problemas e d√∫vidas
   - Fornecer dados espec√≠ficos do projeto do usu√°rio
   - Guiar o usu√°rio pelas funcionalidades

2. **Navega√ß√£o e Orienta√ß√£o**
   - /dashboard - Vis√£o geral e m√©tricas
   - /monitoring - Monitoramento de v√≠deos  
   - /mentions - Men√ß√µes e coment√°rios
   - /scanner - Scanner de v√≠deos do YouTube
   - /projects - Gerenciamento de projetos
   - /integrations - Integra√ß√µes dispon√≠veis
   - /settings - Configura√ß√µes da conta

3. **An√°lise de Dados** (usando contexto RAG)
   - Fornecer estat√≠sticas espec√≠ficas do projeto
   - Analisar tend√™ncias e padr√µes
   - Mostrar insights personalizados
   - Sugerir a√ß√µes baseadas nos dados

## üìä Usando Dados do Contexto

Quando receber dados no contexto RAG, use-os naturalmente:
- "Vi aqui que voc√™ tem X men√ß√µes esta semana..."
- "Seus v√≠deos mais recentes mostram..."
- "O sentimento geral est√°..."
- "As men√ß√µes do Humanlike Writer est√£o..."

Quando o usu√°rio pedir para navegar, responda com:
{
  "content": "Vou te levar para [nome da p√°gina]...",
  "action": "navigate",
  "data": { "path": "/caminho-da-pagina" }
}

Lembre-se: Voc√™ n√£o √© apenas um assistente, voc√™ √© o melhor amigo do usu√°rio no mundo do marketing digital!`;

/**
 * Busca dados relevantes do projeto usando RAG
 * NOTA: Agora usando SDK do Supabase - MELHOR PR√ÅTICA!
 */
async function searchProjectData(prompt: string, projectId: string) {
  try {
    console.log('Buscando dados para projeto:', projectId);
    
    // MELHOR PR√ÅTICA: Usar SDK do Supabase para chamar Edge Functions
    // Isso √© mais seguro, mant√≠vel e segue os padr√µes recomendados
    const { data: embeddingData, error: embeddingError } = await supabase.functions.invoke('generate-embedding', {
      body: { text: prompt }
    });

    if (embeddingError || !embeddingData?.embedding) {
      console.error('Erro ao gerar embedding:', embeddingError);
      return null;
    }

    console.log('Embedding gerado com sucesso via SDK');

    // Buscar dados relevantes usando a fun√ß√£o SQL
    const { data: searchResults, error: searchError } = await supabase.rpc('search_project_rag', {
      query_embedding: embeddingData.embedding,
      project_id_param: parseInt(projectId),
      match_threshold: 0.7,
      match_count: 5
    });

    if (searchError) {
      console.error('Erro na busca RAG:', searchError);
      return null;
    }

    console.log(`Encontrados ${searchResults?.length || 0} resultados relevantes`);
    return searchResults;
  } catch (error) {
    console.error('Erro ao buscar dados do projeto:', error);
    return null;
  }
}

Deno.serve(async (req) => {
  try {
    // CORS headers
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    };

    // Handle CORS preflight
    if (req.method === 'OPTIONS') {
      return new Response('ok', { headers: corsHeaders });
    }

    // Parse do body da requisi√ß√£o
    const { prompt, context = {} } = await req.json();

    if (!prompt) {
      return new Response(
        JSON.stringify({ error: 'Prompt √© obrigat√≥rio' }),
        { 
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    console.log('Prompt recebido:', prompt);
    console.log('Projeto:', context.currentProject);

    // Buscar dados relevantes do projeto via RAG
    let ragContext = '';
    if (context.currentProject?.id) {
      const ragResults = await searchProjectData(prompt, context.currentProject.id);
      
      if (ragResults && ragResults.length > 0) {
        ragContext = '\n\n## Dados relevantes do projeto:\n';
        ragResults.forEach((result: any) => {
          ragContext += `- ${result.content}\n`;
        });
        console.log('Contexto RAG adicionado com', ragResults.length, 'itens');
      }
    }

    // Adicionar contexto ao prompt
    let contextualPrompt = prompt;
    if (context.currentPage) {
      contextualPrompt += `\n\nContexto: Usu√°rio est√° na p√°gina ${context.currentPage}`;
    }
    if (context.currentProject) {
      contextualPrompt += `\nProjeto selecionado: ${context.currentProject.name} (ID: ${context.currentProject.id})`;
    }
    
    // Adicionar dados RAG ao contexto
    if (ragContext) {
      contextualPrompt += ragContext;
    }

    // Chamar API do Claude
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-3-opus-20240229',
        max_tokens: 1024,
        messages: [
          {
            role: 'user',
            content: contextualPrompt
          }
        ],
        system: systemPrompt
      })
    });

    if (!response.ok) {
      const error = await response.text();
      console.error('Erro na API do Claude:', error);
      throw new Error('Erro ao processar sua pergunta');
    }

    const data = await response.json();
    const assistantResponse = data.content[0].text;

    // Tentar parsear a resposta como JSON se contiver action
    try {
      const jsonResponse = JSON.parse(assistantResponse);
      return new Response(
        JSON.stringify(jsonResponse),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    } catch {
      // Se n√£o for JSON, retornar como texto
      return new Response(
        JSON.stringify({ content: assistantResponse }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

  } catch (error) {
    console.error('Erro:', error);
    return new Response(
      JSON.stringify({ 
        error: 'Poxa, encontrei um probleminha... ü§î Tenta de novo em alguns segundos?',
        details: error.message 
      }),
      { 
        status: 500,
        headers: { 'Content-Type': 'application/json' }
      }
    );
  }
});